## COMMAND: ./waste -v2 -Omr,loc --abbrevs=/home/ddc-dstar/dstar/resources/waste/abbr.lex --stopwords=/home/ddc-dstar/dstar/resources/waste/stop.lex --conjunctions=/home/ddc-dstar/dstar/resources/waste/conj.lex --model=/home/ddc-dstar/dstar/resources/waste/model.hmm data_src_grenzboten_341588_105276.txt.txt -o out.t

## DDD
GNU DDD 3.3.12 (x86_64-pc-linux-gnu), by Dorothea LReading symbols from ./waste...done.
(gdb) run -v2 -Omr,loc --abbrevs=/home/ddc-dstar/dstar/resources/waste/abbr.lex --stopwords=/home/ddc-dstar/dstar/resources/waste/stop.lex --conjunctions=/home/ddc-dstar/dstar/resources/waste/conj.lex --model=/home/ddc-dstar/dstar/resources/waste/model.hmm data_src_grenzboten_341588_105276.txt.txt -o out.t
Starting program: /home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste -v2 -Omr,loc --abbrevs=/home/ddc-dstar/dstar/resources/waste/abbr.lex --stopwords=/home/ddc-dstar/dstar/resources/waste/stop.lex --conjunctions=/home/ddc-dstar/dstar/resources/waste/conj.lex --model=/home/ddc-dstar/dstar/resources/waste/model.hmm data_src_grenzboten_341588_105276.txt.txt -o out.t
Continuing.
Continuing.
Continuing.
Continuing.
*** Error in `/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste': double free or corruption (out): 0x0000000000a1dcd0 ***
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7ffff69dd7e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x7fe0a)[0x7ffff69e5e0a]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7ffff69e998c]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x41e123]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x4236b6]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x422c8d]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x421e55]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x41df50]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x41e01d]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x4238ac]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x422f2d]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x4222f6]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x4300ca]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x42fd79]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x4061c9]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x406971]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7ffff6986830]
/home/ddc-dstar/dstar/corpora/grenzboten/build/xml_tok/waste[0x405859]
======= Memory map: ========
00400000-00505000 r-xp 00000000 fc:00 214307136                          /home/moocow/work/moot/moot/src/programs/waste
00704000-00705000 r--p 00104000 fc:00 214307136                          /home/moocow/work/moot/moot/src/programs/waste
00705000-00706000 rw-p 00105000 fc:00 214307136                          /home/moocow/work/moot/moot/src/programs/waste
00706000-00a6c000 rw-p 00000000 00:00 0                                  [heap]
7ffff0000000-7ffff0021000 rw-p 00000000 00:00 0 
7ffff0021000-7ffff4000000 ---p 00000000 00:00 0 
7ffff6966000-7ffff6b25000 r-xp 00000000 fc:00 944202429                  /lib/x86_64-linux-gnu/libc-2.23.so
7ffff6b25000-7ffff6d25000 ---p 001bf000 fc:00 944202429                  /lib/x86_64-linux-gnu/libc-2.23.so
7ffff6d25000-7ffff6d29000 r--p 001bf000 fc:00 944202429                  /lib/x86_64-linux-gnu/libc-2.23.so
7ffff6d29000-7ffff6d2b000 rw-p 001c3000 fc:00 944202429                  /lib/x86_64-linux-gnu/libc-2.23.so
7ffff6d2b000-7ffff6d2f000 rw-p 00000000 00:00 0 
7ffff6d2f000-7ffff6d45000 r-xp 00000000 fc:00 944200693                  /lib/x86_64-linux-gnu/libgcc_s.so.1
7ffff6d45000-7ffff6f44000 ---p 00016000 fc:00 944200693                  /lib/x86_64-linux-gnu/libgcc_s.so.1
7ffff6f44000-7ffff6f45000 rw-p 00015000 fc:00 944200693                  /lib/x86_64-linux-gnu/libgcc_s.so.1
7ffff6f45000-7ffff704d000 r-xp 00000000 fc:00 944178968                  /lib/x86_64-linux-gnu/libm-2.23.so
7ffff704d000-7ffff724c000 ---p 00108000 fc:00 944178968                  /lib/x86_64-linux-gnu/libm-2.23.so
7ffff724c000-7ffff724d000 r--p 00107000 fc:00 944178968                  /lib/x86_64-linux-gnu/libm-2.23.so
7ffff724d000-7ffff724e000 rw-p 00108000 fc:00 944178968                  /lib/x86_64-linux-gnu/libm-2.23.so
7ffff724e000-7ffff73c0000 r-xp 00000000 fc:00 30343416                   /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21
7ffff73c0000-7ffff75c0000 ---p 00172000 fc:00 30343416                   /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21
7ffff75c0000-7ffff75ca000 r--p 00172000 fc:00 30343416                   /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21
7ffff75ca000-7ffff75cc000 rw-p 0017c000 fc:00 30343416                   /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21
7ffff75cc000-7ffff75d0000 rw-p 00000000 00:00 0 
7ffff75d0000-7ffff75f6000 r-xp 00000000 fc:00 944177573                  /lib/x86_64-linux-gnu/libexpat.so.1.6.0
7ffff75f6000-7ffff77f6000 ---p 00026000 fc:00 944177573                  /lib/x86_64-linux-gnu/libexpat.so.1.6.0
7ffff77f6000-7ffff77f8000 r--p 00026000 fc:00 944177573                  /lib/x86_64-linux-gnu/libexpat.so.1.6.0
7ffff77f8000-7ffff77f9000 rw-p 00028000 fc:00 944177573                  /lib/x86_64-linux-gnu/libexpat.so.1.6.0
7ffff77f9000-7ffff7966000 r-xp 00000000 fc:00 30347887                   /usr/lib/x86_64-linux-gnu/librecode.so.0.0.0
7ffff7966000-7ffff7b66000 ---p 0016d000 fc:00 30347887                   /usr/lib/x86_64-linux-gnu/librecode.so.0.0.0
7ffff7b66000-7ffff7bb6000 r--p 0016d000 fc:00 30347887                   /usr/lib/x86_64-linux-gnu/librecode.so.0.0.0
7ffff7bb6000-7ffff7bbd000 rw-p 001bd000 fc:00 30347887                   /usr/lib/x86_64-linux-gnu/librecode.so.0.0.0
7ffff7bbd000-7ffff7bd6000 r-xp 00000000 fc:00 944207524                  /lib/x86_64-linux-gnu/libz.so.1.2.8
7ffff7bd6000-7ffff7dd5000 ---p 00019000 fc:00 944207524                  /lib/x86_64-linux-gnu/libz.so.1.2.8
7ffff7dd5000-7ffff7dd6000 r--p 00018000 fc:00 944207524                  /lib/x86_64-linux-gnu/libz.so.1.2.8
7ffff7dd6000-7ffff7dd7000 rw-p 00019000 fc:00 944207524                  /lib/x86_64-linux-gnu/libz.so.1.2.8
7ffff7dd7000-7ffff7dfd000 r-xp 00000000 fc:00 944199740                  /lib/x86_64-linux-gnu/ld-2.23.so
7ffff7f4a000-7ffff7fe2000 rw-p 00000000 00:00 0 
7ffff7ff5000-7ffff7ff8000 rw-p 00000000 00:00 0 
7ffff7ff8000-7ffff7ffa000 r--p 00000000 00:00 0                          [vvar]
7ffff7ffa000-7ffff7ffc000 r-xp 00000000 00:00 0                          [vdso]
7ffff7ffc000-7ffff7ffd000 r--p 00025000 fc:00 944199740                  /lib/x86_64-linux-gnu/ld-2.23.so
7ffff7ffd000-7ffff7ffe000 rw-p 00026000 fc:00 944199740                  /lib/x86_64-linux-gnu/ld-2.23.so
7ffff7ffe000-7ffff7fff000 rw-p 00000000 00:00 0 
7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]

Program received signal SIGABRT, Aborted.
0x00007ffff699b428 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54
(gdb)

## BACKTRACE

### 1 day of work & notes expunged due to my own stupidity
###  + crashing emacs by killing its xterm
###  + running 'make clean' in build/xml_tok/ where this file was living
###  + naming the file *.txt which build/xml_tok/Makefile deletes
###  + shit; see emails to Kay for summary information

### glibc MALLOC_CHECK_ set to anything at all: no errors
### compile with -D_GLIBCXX_DEBUG: no errors
###  -> see https://en.wikibooks.org/wiki/Linux_Applications_Debugging_Techniques/Heap_corruption

## waste modules
base-cmdline	./waste -v2 -Owd,loc --abbrevs=/home/ddc-dstar/dstar/resources/waste/abbr.lex --stopwords=/home/ddc-dstar/dstar/resources/waste/stop.lex --conjunctions=/home/ddc-dstar/dstar/resources/waste/conj.lex --model=/home/ddc-dstar/dstar/resources/waste/model.hmm data_src_grenzboten_341588_105276.txt.txt -o out.t
double-free	$cmd					# *** Error in `./waste': double free or corruption (out): 0x0000000001030cd0 ***
segfault	$cmd --no-dehyphenate			# Segmentation fault (core dumped)
ok		$cmd --scan
ok		$cmd --scan --lex
ok		$cmd --scan --lex --tag
corruption	$cmd --scan --lex --tag --decode	# *** Error in `./waste': malloc(): memory corruption: 0x0000000001569ab0 ***
double-free	$cmd -sxtd --annotate			# *** Error in `./waste': double free or corruption (out): 0x0000000001063cd0 ***

... no errors when running modules individually with direct file I/O
- errors only when using waste-internal memory reader/writer pairs
- errors only when including --scan step

CONTINUE: print debugging readers/writers ?

SYMTPOMS:
- OK: waste built statically on www.dwds.de --> NO crash running on kira
  : g++ --version    = g++ (Debian 4.9.2-10) 4.9.2
  : dpkg-list.sh g++ = g++ 4:4.9.2-2
- OK: waste built statically on kira with g++-4.9 --> NO crash on kira
  : g++-4.9 --version    = g++-4.9 (Ubuntu 4.9.3-13ubuntu2) 4.9.3
  : dpkg-list.sh g++-4.9 = g++-4.9 4.9.3-13ubuntu2")
- BAD: on kira using default g++
  : g++ --version    = Ubuntu 5.4.0-6ubuntu1~16.04.2) 5.4.0 20160609
  : dpkg-list.sh g++ = 4:5.3.1-1ubuntu1

QUICK-FIX: use g++-4.9 build on kira for now

REPRODUCE:
- errors occur on ubuntu-16.04-64but virtual box @plato
  : NO errors if configured with CPPFLAGS=-D_GLIBCXX_USE_CXX11_ABI=0
    ~ flag switches off use of default c++11 ABI
    ~ see https://developerblog.redhat.com/2015/02/05/gcc5-and-the-c11-abi/
    ~ wikipedia: ABI usually responsible for e.g.
      "the sizes, layouts, and alignments of data types"
      ... resonates with the mis-alignment by 128 bytes we're seeing
  : CPPFLAGS=-D_GLIBCXX_USE_CXX11_ABI=0 also works on kira with gcc5
    ~ interesting discussion at https://gcc.gnu.org/bugzilla/show_bug.cgi?id=53646
    ~ discussion on strings +/- copy-on-write at http://stackoverflow.com/questions/34571583/understanding-gcc-5s-glibcxx-use-cxx11-abi-or-the-new-abi
      * problem description looks similar (failing only w/ c++11 abi)
      * passing around (temporary) strings and c_str() is something moot does a lot of

CHECK BINARY:
- you can check which C++ABI a binary (library) uses by calling nm and looking for the '__cxx11' pseudo-namespace, e.g.
    $ nm -C waste.g++-5-oldabi | grep -P '\bmootToken\b' | head ##-- g++ v5.x, old ABI, static [ok]
    000000000041bf28 T moot::TokenBuffer::put_tokens(std::list<moot::mootToken, std::allocator<moot::mootToken> > const&)
    000000000041bf92 T moot::TokenBuffer::put_sentence(std::list<moot::mootToken, std::allocator<moot::mootToken> > const&)
  vs.
    $ nm -C waste.g++-5 | grep -P '\bmootToken\b' | head ##-- g++ v5.x, default new ABI, static [crashes]
    000000000041dc30 T moot::TokenBuffer::put_tokens(std::__cxx11::list<moot::mootToken, std::allocator<moot::mootToken> > const&)
    000000000041dc9e T moot::TokenBuffer::put_sentence(std::__cxx11::list<moot::mootToken, std::allocator<moot::mootToken> > const&)
  vs.
    $ nm -C waste.g++-5 | grep -P '\bmootToken\b' | head ##-- g++ v4.9, default old ABI, static [ok]
    000000000041b3d8 T moot::TokenBuffer::put_tokens(std::list<moot::mootToken, std::allocator<moot::mootToken> > const&)
    000000000041b444 T moot::TokenBuffer::put_sentence(std::list<moot::mootToken, std::allocator<moot::mootToken> > const&)
  vs.
    $ nm -C /usr/local/lib/libmoot.so | grep -P '\bmootToken\b' | head ##-- g++ v4.9, default old ABI, dynamic [ok]
    00000000000443f0 T moot::TokenBuffer::put_tokens(std::list<moot::mootToken, std::allocator<moot::mootToken> > const&)
    0000000000043df0 T moot::TokenBuffer::put_sentence(std::list<moot::mootToken, std::allocator<moot::mootToken> > const&)

